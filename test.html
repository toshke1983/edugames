<!DOCTYPE html>
<html>
<head>
    <title>Europe Map Quiz</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f4f7f6; margin: 0; padding: 20px; }
        #game-container { margin: 0 auto; max-width: 1000px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        #streak { color: #e67e22; transition: all 0.2s; }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        svg { width: 100%; height: auto; max-height: 65vh; border: 1px solid #eee; border-radius: 10px; margin-top: 10px;}
        svg path { fill: #d1d8e0; stroke: #ffffff; stroke-width: 0.5; cursor: pointer; transition: fill 0.2s; }
        svg path:hover { fill: #45aaf2 !important; }
        #target-country { color: #2d3436; font-size: 2.2em; margin: 10px 0; min-height: 1.2em; display: flex; align-items: center; justify-content: center; gap: 15px; }
        #score-board { font-size: 1.5em; color: #20bf6b; font-weight: bold; }
        #message { height: 40px; margin-top: 10px; font-size: 1.3em; font-weight: bold; }
        .btn { margin-top: 5px; padding: 10px 20px; cursor: pointer; border-radius: 5px; border: none; background: #dfe6e9; font-weight: bold; }
        .btn:hover { background: #b2bec3; }
    </style>
</head>
<body>

<div id="game-container">
    <h1>Europe Map Explorer üåç</h1>
    <div id="score-board">
        Score: <span id="score">0</span> | 
        Streak: <span id="streak">0</span> üî• | 
        Best: <span id="best-streak">0</span> üèÜ
    </div>
    
    <div id="target-country">Loading...</div>
    
    <button class="btn" onclick="skipCountry()">Skip Country ‚è≠Ô∏è</button>
    <div id="message"></div>

    <div id="map-placeholder"></div>
</div>

<script>
    // Expanded Data Structure: Name, Capital, and Emoji Flag
    const countryData = {
        "AT": { name: "Austria", cap: "Vienna", flag: "üá¶üáπ" },
        "BE": { name: "Belgium", cap: "Brussels", flag: "üáßüá™" },
        "FR": { name: "France", cap: "Paris", flag: "üá´üá∑" },
        "DE": { name: "Germany", cap: "Berlin", flag: "üá©üá™" },
        "LU": { name: "Luxembourg", cap: "Luxembourg", flag: "üá±üá∫" },
        "NL": { name: "Netherlands", cap: "Amsterdam", flag: "üá≥üá±" },
        "CH": { name: "Switzerland", cap: "Bern", flag: "üá®üá≠" },
        "DK": { name: "Denmark", cap: "Copenhagen", flag: "üá©üá∞" },
        "EE": { name: "Estonia", cap: "Tallinn", flag: "üá™üá™" },
        "FI": { name: "Finland", cap: "Helsinki", flag: "üá´üáÆ" },
        "IS": { name: "Iceland", cap: "Reykjavik", flag: "üáÆüá∏" },
        "IE": { name: "Ireland", cap: "Dublin", flag: "üáÆüá™" },
        "LV": { name: "Latvia", cap: "Riga", flag: "üá±üáª" },
        "LT": { name: "Lithuania", cap: "Vilnius", flag: "üá±üáπ" },
        "NO": { name: "Norway", cap: "Oslo", flag: "üá≥üá¥" },
        "SE": { name: "Sweden", cap: "Stockholm", flag: "üá∏üá™" },
        "GB": { name: "United Kingdom", cap: "London", flag: "üá¨üáß" },
        "AL": { name: "Albania", cap: "Tirana", flag: "üá¶üá±" },
        "BA": { name: "Bosnia and Herzegovina", cap: "Sarajevo", flag: "üáßüá¶" },
        "HR": { name: "Croatia", cap: "Zagreb", flag: "üá≠üá∑" },
        "GR": { name: "Greece", cap: "Athens", flag: "üá¨üá∑" },
        "IT": { name: "Italy", cap: "Rome", flag: "üáÆüáπ" },
        "ME": { name: "Montenegro", cap: "Podgorica", flag: "üá≤üá™" },
        "MK": { name: "North Macedonia", cap: "Skopje", flag: "üá≤üá∞" },
        "PT": { name: "Portugal", cap: "Lisbon", flag: "üáµüáπ" },
        "RS": { name: "Serbia", cap: "Belgrade", flag: "üá∑üá∏" },
        "ES": { name: "Spain", cap: "Madrid", flag: "üá™üá∏" },
        "CY": { name: "Cyprus", cap: "Nicosia", flag: "üá®üáæ" },
        "XK": { name: "Kosovo", cap: "Pristina", flag: "üáΩüá∞" },
        "BY": { name: "Belarus", cap: "Minsk", flag: "üáßüáæ" },
        "BG": { name: "Bulgaria", cap: "Sofia", flag: "üáßüá¨" },
        "CZ": { name: "Czech Republic", cap: "Prague", flag: "üá®üáø" },
        "HU": { name: "Hungary", cap: "Budapest", flag: "üá≠üá∫" },
        "MD": { name: "Moldova", cap: "Chisinau", flag: "üá≤üá©" },
        "PL": { name: "Poland", cap: "Warsaw", flag: "üáµüá±" },
        "RO": { name: "Romania", cap: "Bucharest", flag: "üá∑üá¥" },
        "SK": { name: "Slovakia", cap: "Bratislava", flag: "üá∏üá∞" },
        "SI": { name: "Slovenia", cap: "Ljubljana", flag: "üá∏üáÆ" },
        "UA": { name: "Ukraine", cap: "Kyiv", flag: "üá∫üá¶" },
        "TR": { name: "Turkey", cap: "Ankara", flag: "üáπüá∑" }
    };

    let weights = {}; 
    let currentID = ""; 
    let previousID = "";
    let score = 0;
    let streak = 0;
    let maxStreak = 0;
    let failureMade = False;

    // Initialize weights
    Object.keys(countryData).forEach(id => weights[id] = 1.0);

    fetch('europe.svg')
        .then(response => response.text())
        .then(svgData => {
            document.getElementById('map-placeholder').innerHTML = svgData;
            setupGame();
        });

    function setupGame() {
        const paths = document.querySelectorAll('svg path');
        paths.forEach(path => {
            path.addEventListener('click', function() {
                const clickedID = this.id.toUpperCase();
                const clickedInfo = countryData[clickedID];

                if (clickedID === currentID) {
                    handleSuccess(this);
                } else {
                    handleFailure(clickedID, clickedInfo);
                }
            });
        });
        nextQuestion();
    }

    function handleSuccess(element) {
        score++;
        streak++;
        if (!failureMade) {
            weights[currentID] = 1.0; // Reset weight on success
        }
        
        if (streak > maxStreak) {
            maxStreak = streak;
            document.getElementById('best-streak').innerText = maxStreak;
        }

        document.getElementById('score').innerText = score;
        document.getElementById('streak').innerText = streak;
        
        if (streak % 5 === 0) launchCelebration();

        document.getElementById('message').innerText = `Perfect! Streak: ${streak} üî•`;
        document.getElementById('message').style.color = "#20bf6b";
        
        element.style.fill = "#2ecc71"; 
        setTimeout(() => {
            element.style.fill = ""; 
            nextQuestion();
        }, 800);
    }

    function handleFailure(clickedID, clickedInfo) {
        streak = 0;
        document.getElementById('streak').innerText = streak;
        
        // Boost probability of the missed country
        failureMade = True; // setting so we don't bring the probability distor back to 1.0
        weights[currentID] *= 1.25; 

        document.getElementById('game-container').classList.add('shake');
        setTimeout(() => document.getElementById('game-container').classList.remove('shake'), 500);

        const wrongName = clickedInfo ? clickedInfo.name : "another area";
        document.getElementById('message').innerText = `Oops! That's ${wrongName}. Streak lost! üßä`;
        document.getElementById('message').style.color = "#eb4d4b";
    }

    function nextQuestion() {
        previousID = currentID;
        const keys = Object.keys(countryData);
        
        // Weighted random selection
        let totalWeight = 0;
        keys.forEach(key => totalWeight += weights[key]);

        let random;
        let selectedKey;

        // Ensure no immediate repeats
        do {
            random = Math.random() * totalWeight;
            let sum = 0;
            for (let i = 0; i < keys.length; i++) {
                sum += weights[keys[i]];
                if (random <= sum) {
                    selectedKey = keys[i];
                    break;
                }
            }
        } while (selectedKey === previousID && keys.length > 1);

        currentID = selectedKey;
        const info = countryData[currentID];

        // Randomly decide to ask for Country or Capital (50/50 chance)
        const askForCapital = Math.random() > 0.5;
        const promptText = askForCapital 
            ? `Find the country with capital: <b>${info.cap}</b>` 
            : `Find: <b>${info.name}</b>`;
        
        document.getElementById('target-country').innerHTML = `${info.flag} ${promptText}`;
        document.getElementById('message').innerText = "";
        
        failureMade = False; // resetting the failure for the next step
    }

    function skipCountry() {
        weights[currentID] *= 1.25; // Small boost if skipped
        streak = 0;
        document.getElementById('streak').innerText = streak;
        nextQuestion();
    }

    function launchCelebration() {
        const duration = 2000;
        const end = Date.now() + duration;
        (function frame() {
            confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 } });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    }
</script>
</body>
</html>
