<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Ultimate Capital Master: Expert Edition</title>
    <style>
        :root {
            --primary: #4A90E2; --success: #6BCB77; --warning: #FFA502; --danger: #FF6B6B; --bg: #F0F7FF;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #game-container { background: white; padding: 2rem; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 550px; border: 8px solid var(--primary); max-height: 90vh; overflow-y: auto; }
        .hidden { display: none !important; }
        .menu-btn { background: var(--primary); color: white; border: none; padding: 15px 20px; font-size: 1rem; border-radius: 50px; margin: 8px; cursor: pointer; transition: 0.2s; font-weight: bold; width: 90%; }
        .menu-btn:hover { transform: scale(1.03); opacity: 0.9; }
        .btn-selection { background: #9B59B6; }
        .btn-typing { background: #2ECC71; }
        .flag { font-size: 5rem; margin: 10px 0; display: block; }
        .country-name { font-size: 1.8rem; font-weight: bold; margin-bottom: 20px; }
        .options-container { display: grid; gap: 10px; }
        .option-btn { background: #f8f9fa; border: 3px solid #dee2e6; padding: 15px; font-size: 1.1rem; border-radius: 15px; cursor: pointer; font-weight: 600; }
        input[type="text"] { width: 80%; padding: 15px; font-size: 1.2rem; border: 3px solid var(--primary); border-radius: 15px; margin-bottom: 15px; outline: none; }
        .correct { background: var(--success) !important; color: white; border-color: #4cae4c !important; }
        .near { background: var(--warning) !important; color: white; border-color: #e67e22 !important; }
        .wrong { background: var(--danger) !important; color: white; border-color: #d9534f !important; }
        .score-board { font-size: 1rem; margin-bottom: 15px; color: #888; font-weight: bold; }
        .review-card { background: #fdfdfd; border: 1px solid #eee; border-radius: 12px; padding: 8px; margin-top: 8px; display: flex; align-items: center; gap: 15px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="lang-screen">
        <h1>Welcome! / Willkommen!</h1>
        <button class="menu-btn" onclick="setLanguage('en')" style="background:#FF9F43">English üá¨üáß</button>
        <button class="menu-btn" onclick="setLanguage('de')" style="background:#FF9F43">Deutsch üá©üá™</button>
    </div>

    <div id="start-menu" class="hidden">
        <h1 id="ui-title"></h1>
        <p id="ui-subtitle"></p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <div><small>Multiple Choice</small><button class="menu-btn btn-selection" onclick="startGame(10, 'select')" id="ui-s10"></button><button class="menu-btn btn-selection" onclick="startGame(51, 'select')" id="ui-sAll"></button></div>
            <div><small>Typing Mode</small><button class="menu-btn btn-typing" onclick="startGame(10, 'type')" id="ui-t10"></button><button class="menu-btn btn-typing" onclick="startGame(51, 'type')" id="ui-tAll"></button></div>
        </div>
    </div>

    <div id="quiz-screen" class="hidden">
        <div class="score-board"><span id="ui-qtext"></span> <span id="q-count">1</span> | <span id="ui-stext"></span>: <span id="current-score">0</span></div>
        <div id="question-box">
            <span class="flag" id="flag-display"></span>
            <div class="country-name" id="country-display"></div>
            <div id="selection-area" class="options-container hidden"></div>
            <div id="typing-area" class="hidden">
                <input type="text" id="user-input" autocomplete="off" placeholder="...">
                <button class="menu-btn" onclick="handleTypeSubmit()" id="ui-submit">Submit</button>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h1 id="ui-res-title"></h1>
        <div style="font-size: 3.5rem; color: var(--success);" id="total-score">0</div>
        <p id="score-message"></p>
        <div id="review-area" class="hidden" style="text-align: left; margin-top: 20px;"><h3 id="ui-review-title"></h3><div id="mistakes-list"></div></div>
        <button class="menu-btn" onclick="location.reload()" id="ui-again"></button>
    </div>
</div>

<script>
    const i18n = {
        en: { title: "üåç Capital Master", subtitle: "Pick a mode!", s10: "Short (10)", sAll: "Marathon (51)", t10: "Short (10)", tAll: "Marathon (51)", question: "Question", score: "Points", finish: "Game Over!", playAgain: "üîÑ Try Again", submit: "Check", reviewTitle: "Review:", perfect: "Perfect! üèÜ", near: "Almost! ü§è", wrong: "Wrong! ‚ùå" },
        de: { title: "üåç Hauptstadt-Meister", subtitle: "W√§hle einen Modus!", s10: "Kurz (10)", sAll: "Marathon (51)", t10: "Kurz (10)", tAll: "Marathon (51)", question: "Frage", score: "Punkte", finish: "Beendet!", playAgain: "üîÑ Nochmal", submit: "Pr√ºfen", reviewTitle: "R√ºckblick:", perfect: "Perfekt! üèÜ", near: "Fast! ü§è", wrong: "Falsch! ‚ùå" }
    };

    // DECOY POOL: Famous non-capitals
    const decoys = {
        en: ["Barcelona", "Munich", "Milan", "Istanbul", "Zurich", "Geneva", "Frankfurt", "Lyon", "Marseille", "Birmingham", "Manchester", "Glasgow", "Rotterdam", "Antwerp", "Hamburg", "Naples", "Venice", "Florence", "Seville", "Valencia", "St. Petersburg", "Krakow", "Gdansk", "Porto", "Salzburg", "Innsbruck", "Gothenburg", "Bergen", "Turku", "Basel", "Thessaloniki", "Bordeaux", "Cologne", "Leipzig", "Stuttgart", "Palermo", "Bilbao", "Alicante", "Brno", "Debrecen", "Cluj-Napoca", "Split", "Varna", "Cork", "Galway", "Uppsala"],
        de: ["Barcelona", "M√ºnchen", "Mailand", "Istanbul", "Z√ºrich", "Genf", "Frankfurt", "Lyon", "Marseille", "Birmingham", "Manchester", "Glasgow", "Rotterdam", "Antwerpen", "Hamburg", "Neapel", "Venedig", "Florenz", "Sevilla", "Valencia", "St. Petersburg", "Krakau", "Danzig", "Porto", "Salzburg", "Innsbruck", "G√∂teborg", "Bergen", "Turku", "Basel", "Thessaloniki", "Bordeaux", "K√∂ln", "Leipzig", "Stuttgart", "Palermo", "Bilbao", "Alicante", "Br√ºnn", "Debrecen", "Klausenburg", "Split", "Varna", "Cork", "Galway", "Uppsala"]
    };

    const countries = [
        { flag: "üá´üá∑", en: { n: "France", c: "Paris" }, de: { n: "Frankreich", c: "Paris" } },
        { flag: "üá©üá™", en: { n: "Germany", c: "Berlin" }, de: { n: "Deutschland", c: "Berlin" } },
        { flag: "üáÆüáπ", en: { n: "Italy", c: "Rome" }, de: { n: "Italien", c: "Rom" } },
        { flag: "üá™üá∏", en: { n: "Spain", c: "Madrid" }, de: { n: "Spanien", c: "Madrid" } },
        { flag: "üá¨üáß", en: { n: "United Kingdom", c: "London" }, de: { n: "Gro√übritannien", c: "London" } },
        { flag: "üá∑üá∫", en: { n: "Russia", c: "Moscow" }, de: { n: "Russland", c: "Moskau" } },
        { flag: "üáπüá∑", en: { n: "Turkey", c: "Ankara" }, de: { n: "T√ºrkei", c: "Ankara" } },
        { flag: "üá∫üá¶", en: { n: "Ukraine", c: "Kyiv" }, de: { n: "Ukraine", c: "Kiew" } },
        { flag: "üáµüá±", en: { n: "Poland", c: "Warsaw" }, de: { n: "Polen", c: "Warschau" } },
        { flag: "üá≥üá±", en: { n: "Netherlands", c: "Amsterdam" }, de: { n: "Niederlande", c: "Amsterdam" } },
        { flag: "üáßüá™", en: { n: "Belgium", c: "Brussels" }, de: { n: "Belgien", c: "Br√ºssel" } },
        { flag: "üá¨üá∑", en: { n: "Greece", c: "Athens" }, de: { n: "Griechenland", c: "Athen" } },
        { flag: "üáµüáπ", en: { n: "Portugal", c: "Lisbon" }, de: { n: "Portugal", c: "Lissabon" } },
        { flag: "üá∏üá™", en: { n: "Sweden", c: "Stockholm" }, de: { n: "Schweden", c: "Stockholm" } },
        { flag: "üá≥üá¥", en: { n: "Norway", c: "Oslo" }, de: { n: "Norwegen", c: "Oslo" } },
        { flag: "üá©üá∞", en: { n: "Denmark", c: "Copenhagen" }, de: { n: "D√§nemark", c: "Kopenhagen" } },
        { flag: "üá´üáÆ", en: { n: "Finland", c: "Helsinki" }, de: { n: "Finnland", c: "Helsinki" } },
        { flag: "üá¶üáπ", en: { n: "Austria", c: "Vienna" }, de: { n: "√ñsterreich", c: "Wien" } },
        { flag: "üá®üá≠", en: { n: "Switzerland", c: "Bern" }, de: { n: "Schweiz", c: "Bern" } },
        { flag: "üáÆüá™", en: { n: "Ireland", c: "Dublin" }, de: { n: "Irland", c: "Dublin" } },
        { flag: "üá®üáø", en: { n: "Czechia", c: "Prague" }, de: { n: "Tschechien", c: "Prag" } },
        { flag: "üá≠üá∫", en: { n: "Hungary", c: "Budapest" }, de: { n: "Ungarn", c: "Budapest" } },
        { flag: "üá∑üá¥", en: { n: "Romania", c: "Bucharest" }, de: { n: "Rum√§nien", c: "Bukarest" } },
        { flag: "üáßüá¨", en: { n: "Bulgaria", c: "Sofia" }, de: { n: "Bulgarien", c: "Sofia" } },
        { flag: "üá≠üá∑", en: { n: "Croatia", c: "Zagreb" }, de: { n: "Kroatien", c: "Zagreb" } },
        { flag: "üá∏üá∞", en: { n: "Slovakia", c: "Bratislava" }, de: { n: "Slowakei", c: "Bratislava" } },
        { flag: "üá∏üáÆ", en: { n: "Slovenia", c: "Ljubljana" }, de: { n: "Slowenien", c: "Ljubljana" } },
        { flag: "üá™üá™", en: { n: "Estonia", c: "Tallinn" }, de: { n: "Estland", c: "Tallinn" } },
        { flag: "üá±üáª", en: { n: "Latvia", c: "Riga" }, de: { n: "Lettland", c: "Riga" } },
        { flag: "üá±üáπ", en: { n: "Lithuania", c: "Vilnius" }, de: { n: "Litauen", c: "Vilnius" } },
        { flag: "üáÆüá∏", en: { n: "Iceland", c: "Reykjavik" }, de: { n: "Island", c: "Reykjav√≠k" } },
        { flag: "üá±üá∫", en: { n: "Luxembourg", c: "Luxembourg" }, de: { n: "Luxemburg", c: "Luxemburg" } },
        { flag: "üá≤üáπ", en: { n: "Malta", c: "Valletta" }, de: { n: "Malta", c: "Valletta" } },
        { flag: "üá®üáæ", en: { n: "Cyprus", c: "Nicosia" }, de: { n: "Zypern", c: "Nikosia" } },
        { flag: "üá¶üá±", en: { n: "Albania", c: "Tirana" }, de: { n: "Albanien", c: "Tirana" } },
        { flag: "üá¶üá©", en: { n: "Andorra", c: "Andorra la Vella" }, de: { n: "Andorra", c: "Andorra la Vella" } },
        { flag: "üáßüá¶", en: { n: "Bosnia and Herzegovina", c: "Sarajevo" }, de: { n: "Bosnien und Herzegowina", c: "Sarajevo" } },
        { flag: "üá±üáÆ", en: { n: "Liechtenstein", c: "Vaduz" }, de: { n: "Liechtenstein", c: "Vaduz" } },
        { flag: "üá≤üá®", en: { n: "Monaco", c: "Monaco" }, de: { n: "Monaco", c: "Monaco" } },
        { flag: "üá≤üá™", en: { n: "Montenegro", c: "Podgorica" }, de: { n: "Montenegro", c: "Podgorica" } },
        { flag: "üá≤üá∞", en: { n: "North Macedonia", c: "Skopje" }, de: { n: "Nordmazedonien", c: "Skopje" } },
        { flag: "üá∏üá≤", en: { n: "San Marino", c: "San Marino" }, de: { n: "San Marino", c: "San Marino" } },
        { flag: "üá∑üá∏", en: { n: "Serbia", c: "Belgrade" }, de: { n: "Serbien", c: "Belgrad" } },
        { flag: "üá≤üá©", en: { n: "Moldova", c: "Chisinau" }, de: { n: "Moldawien", c: "Chisinau" } },
        { flag: "üáßüáæ", en: { n: "Belarus", c: "Minsk" }, de: { n: "Belarus", c: "Minsk" } },
        { flag: "üáªüá¶", en: { n: "Vatican City", c: "Vatican City" }, de: { n: "Vatikanstadt", c: "Vatikanstadt" } },
        { flag: "üáΩüá∞", en: { n: "Kosovo", c: "Pristina" }, de: { n: "Kosovo", c: "Pristina" } },
        { flag: "üá¨üá™", en: { n: "Georgia", c: "Tbilisi" }, de: { n: "Georgien", c: "Tiflis" } },
        { flag: "üá¶üá≤", en: { n: "Armenia", c: "Yerevan" }, de: { n: "Armenien", c: "Jerewan" } },
        { flag: "üá¶üáø", en: { n: "Azerbaijan", c: "Baku" }, de: { n: "Aserbaidschan", c: "Baku" } },
        { flag: "üá∞üáø", en: { n: "Kazakhstan", c: "Astana" }, de: { n: "Kasachstan", c: "Astana" } }
    ];

    let currentLang = 'en', gameMode = 'select', gameQuestions = [], currentIdx = 0, score = 0, canAnswer = true, mistakes = [];

    function setLanguage(lang) {
        currentLang = lang; const t = i18n[lang];
        document.getElementById('ui-title').innerText = t.title; document.getElementById('ui-subtitle').innerText = t.subtitle;
        document.getElementById('ui-s10').innerText = t.s10; document.getElementById('ui-sAll').innerText = t.sAll;
        document.getElementById('ui-t10').innerText = t.t10; document.getElementById('ui-tAll').innerText = t.tAll;
        document.getElementById('ui-qtext').innerText = t.question; document.getElementById('ui-stext').innerText = t.score;
        document.getElementById('ui-res-title').innerText = t.finish; document.getElementById('ui-again').innerText = t.playAgain;
        document.getElementById('ui-submit').innerText = t.submit; document.getElementById('ui-review-title').innerText = t.reviewTitle;
        document.getElementById('lang-screen').classList.add('hidden'); document.getElementById('start-menu').classList.remove('hidden');
    }

    function startGame(num, mode) {
        gameMode = mode; gameQuestions = [...countries].sort(() => 0.5 - Math.random()).slice(0, num);
        currentIdx = 0; score = 0; mistakes = [];
        document.getElementById('start-menu').classList.add('hidden'); document.getElementById('quiz-screen').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        canAnswer = true; const c = gameQuestions[currentIdx]; const langData = c[currentLang];
        document.getElementById('q-count').innerText = currentIdx + 1; document.getElementById('current-score').innerText = score;
        document.getElementById('flag-display').innerText = c.flag; document.getElementById('country-display').innerText = langData.n;
        if (gameMode === 'select') {
            document.getElementById('selection-area').classList.remove('hidden'); document.getElementById('typing-area').classList.add('hidden');
            generateSmartOptions(langData.c);
        } else {
            document.getElementById('selection-area').classList.add('hidden'); document.getElementById('typing-area').classList.remove('hidden');
            const input = document.getElementById('user-input'); input.value = ''; input.className = ''; input.focus();
        }
    }

    function generateSmartOptions(correct) {
        let firstLetter = correct[0];
        // 1. Get all possible wrong options (Capitals + Decoys)
        let pool = [...countries.map(x => x[currentLang].c), ...decoys[currentLang]].filter(x => x !== correct);
        
        // 2. Prioritize cities with the same first letter
        let similar = pool.filter(x => x[0] === firstLetter);
        similar.sort(() => 0.5 - Math.random());
        
        // 3. Select 2 wrong options
        let finalWrong = [];
        if(similar.length >= 2) finalWrong = similar.slice(0, 2);
        else {
            finalWrong = similar;
            let others = pool.filter(x => !finalWrong.includes(x)).sort(() => 0.5 - Math.random());
            finalWrong.push(...others.slice(0, 2 - finalWrong.length));
        }

        let options = [correct, ...finalWrong].sort(() => 0.5 - Math.random());
        const div = document.getElementById('selection-area'); div.innerHTML = '';
        options.forEach(opt => {
            const btn = document.createElement('button'); btn.className = 'option-btn'; btn.innerText = opt;
            btn.onclick = () => checkAnswerSelection(opt, btn, correct); div.appendChild(btn);
        });
    }

    function normalize(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }

    function getLevenshtein(a, b) {
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) matrix[i][j] = matrix[i - 1][j - 1];
                else matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
            }
        }
        return matrix[b.length][a.length];
    }

    function handleTypeSubmit() {
        if(!canAnswer) return; const userInput = document.getElementById('user-input').value;
        const correctReal = gameQuestions[currentIdx][currentLang].c;
        const normUser = normalize(userInput), normCorrect = normalize(correctReal);
        const field = document.getElementById('user-input'); canAnswer = false;

        if (userInput === correctReal) { score += 2; field.classList.add('correct'); alertMsg(i18n[currentLang].perfect, 'success'); }
        else if (getLevenshtein(normUser, normCorrect) <= 2) { score += 1; field.classList.add('near'); alertMsg(i18n[currentLang].near + " (" + correctReal + ")", 'warning'); mistakes.push(gameQuestions[currentIdx]); }
        else { field.classList.add('wrong'); mistakes.push(gameQuestions[currentIdx]); alertMsg(i18n[currentLang].wrong + " -> " + correctReal, 'danger'); }
        nextQ();
    }

    function checkAnswerSelection(sel, btn, cor) {
        if(!canAnswer) return; canAnswer = false;
        if(sel === cor) { score++; btn.classList.add('correct'); }
        else { btn.classList.add('wrong'); mistakes.push(gameQuestions[currentIdx]); Array.from(document.getElementsByClassName('option-btn')).forEach(b => { if(b.innerText === cor) b.classList.add('correct'); }); }
        nextQ();
    }

    function alertMsg(txt, type) {
        const m = document.createElement('div'); m.innerText = txt;
        m.style.cssText = `color:white; background:var(--${type}); padding:10px; border-radius:10px; margin-top:10px; font-weight:bold;`;
        document.getElementById('question-box').appendChild(m); setTimeout(() => m.remove(), gameMode === 'select' ? 1100 : 2900);
    }

    function nextQ() { setTimeout(() => { currentIdx++; if(currentIdx < gameQuestions.length) showQuestion(); else showResults(); }, gameMode === 'select' ? 1200 : 3000); }

    function showResults() {
        document.getElementById('quiz-screen').classList.add('hidden'); document.getElementById('result-screen').classList.remove('hidden');
        const max = gameMode === 'type' ? gameQuestions.length * 2 : gameQuestions.length;
        document.getElementById('total-score').innerText = `${score} / ${max}`;
        if(mistakes.length > 0) {
            document.getElementById('review-area').classList.remove('hidden'); const list = document.getElementById('mistakes-list'); list.innerHTML = '';
            mistakes.forEach(m => { list.innerHTML += `<div class="review-card"><span style="font-size:2rem">${m.flag}</span><div><strong>${m[currentLang].n}</strong>: <span style="color:var(--success)">${m[currentLang].c}</span></div></div>`; });
        }
    }

    document.getElementById('user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleTypeSubmit(); });
</script>
</body>
</html>
